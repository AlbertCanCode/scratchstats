<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch Stats Pro</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="main-content">
        <h1>Scratch Stats</h1>
        <form id="statsForm">
            <input type="text" name="username1" placeholder="User 1" required>
            {% if view_mode == 'compare' %}
            <input type="text" name="username2" placeholder="User 2" required>
            {% endif %}
            <button type="submit" class="project-btn">Analyze</button>
        </form>

        <div id="export-container" style="display:none;">
            <button id="downloadBtn" class="project-btn" style="background: #4dffb4;">Download JSON</button>
        </div>

        <div id="chart-wrap" style="display:none;">
            <canvas id="comparisonChart"></canvas>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let myChart = null;
        let lastData = null;

        document.getElementById('statsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = "Loading...";
            
            const response = await fetch('/api/stats', { method: 'POST', body: new FormData(e.target) });
            const result = await response.json();

            if (result.error) {
                resultsDiv.innerHTML = `<p style="color:red">${result.error}</p>`;
                return;
            }

            lastData = result.data;
            displayResults(result.data);
            
            if (result.data.user1 && result.data.user2) {
                renderChart(result.data.user1, result.data.user2);
            }
        });

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            document.getElementById('export-container').style.display = 'block';
            let html = '<div class="stats-grid">';
            
            const u1 = data.user1;
            const u2 = data.user2;

            const getWin = (u, other, key) => (other && u[key] > other[key]) ? 'winner-glow' : '';

            [u1, u2].forEach(u => {
                if (!u) return;
                const other = (u === u1) ? u2 : u1;
                html += `
                    <div class="user-card">
                        <img src="${u.profile_pic}" class="profile-img">
                        <h2>${u.username}</h2>
                        <p>Followers: <span class="${getWin(u, other, 'followers')}">${u.followers}</span></p>
                        <p>Total Loves: <span class="${getWin(u, other, 'total_loves')}">${u.total_loves}</span></p>
                        <p>Projects: <span class="${getWin(u, other, 'project_count')}">${u.project_count}</span></p>
                    </div>
                `;
            });
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function renderChart(u1, u2) {
            document.getElementById('chart-wrap').style.display = 'block';
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Followers', 'Loves', 'Projects'],
                    datasets: [
                        { label: u1.username, data: [u1.followers, u1.total_loves, u1.project_count], backgroundColor: '#00ff9f' },
                        { label: u2.username, data: [u2.followers, u2.total_loves, u2.project_count], backgroundColor: '#4dffb4bb' }
                    ]
                },
                options: { plugins: { legend: { labels: { color: '#fff' } } } }
            });
        }

        document.getElementById('downloadBtn').addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(lastData, null, 2)], {type : 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'stats.json';
            a.click();
        });
    </script>
</body>
</html>
