<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="google-site-verification" content="hxiX__ldpj9hmreGCLfXADf1fZYuTdIq3i8BY7imPU0" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch Stats</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    
    <nav>
        <div class="nav-container">
            <div class="nav-links">
                <a href="/" id="single-link" class="nav-link">Single Search</a>
                <a href="/compare" id="compare-link" class="nav-link">Compare Stats</a>
            </div>
        </div>
    </nav>
    
    <div class="main-content">
        <h1 id="main-header">Scratch Stats</h1>
        <p id="main-subheader">Enter a Scratch username below 👇</p>

        <form id="statsForm" data-mode="{{ view_mode }}">
            <div class="input-group">
                <input type="text" id="username1" name="username1" placeholder="e.g ChessProKing-TM" required>
                <input type="text" id="username2" name="username2" placeholder="e.g griffpatch">
            </div>
            <button type="submit" id="submitBtn">Get Stats</button>
        </form>

        <div id="stats"></div>
    </div>

    <footer>
        Made by Scratch user <a href="https://scratch.mit.edu/users/ChessProKing-TM" target="_blank">ChessProKing-TM</a>
    </footer>

    <script>
        const form = document.getElementById("statsForm");
        const statsDiv = document.getElementById("stats");
        const submitBtn = document.getElementById("submitBtn");
        const username1Input = document.getElementById("username1");
        const viewMode = form.dataset.mode;
        const header = document.getElementById("main-header");
        const subheader = document.getElementById("main-subheader");
        
        // --- Setup View Mode and Navigation ---
        const username2Input = document.getElementById('username2');

        if (viewMode === 'compare') {
            header.textContent = 'Compare Two Scratch Users';
            subheader.textContent = 'Enter the usernames you want to compare.';
            username2Input.style.display = 'block';
            username2Input.required = true;
            document.getElementById('compare-link').classList.add('active');
        } else {
            // SINGLE VIEW
            header.textContent = 'Scratch Stats';
            subheader.textContent = 'Enter a Scratch username below 👇';
            username2Input.style.display = 'none';
            username2Input.required = false;
            document.getElementById('single-link').classList.add('active');
        }
        
        // --- Form Submission Handler (Handles both views) ---
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const username1 = username1Input.value.trim();
            const username2 = username2Input.value.trim();
            
            // UX Improvement: Loading State and Button Disabling
            statsDiv.innerHTML = '<div class="loading-spinner"></div> Fetching data...';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Fetching...';

            if (!username1) {
                statsDiv.textContent = "❌ Please enter a username.";
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get Stats'; // Fixed text
                return;
            }

            if (viewMode === 'compare' && !username2) {
                statsDiv.textContent = "❌ Please enter both usernames for comparison.";
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get Stats'; // Fixed text
                return;
            }

            const params = new URLSearchParams();
            params.append('username1', username1);
            if (username2) {
                params.append('username2', username2);
            }

            try {
                const res = await fetch("/api/stats", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: params.toString()
                });
                
                const response = await res.json();
                
                if (!res.ok) {
                    statsDiv.textContent = `❌ Error: ${response.error || 'Could not connect to server/API.'}`;
                    return;
                }
                
                const data = response.data;
                const errors = response.errors || {};

                if (viewMode === 'compare' && (data.user1 && data.user2)) {
                    // Pass the comparison data to a new helper function
                    statsDiv.innerHTML = renderComparison(data.user1, data.user2, errors, getWinners(data.user1, data.user2));
                } else if (data.user1 && viewMode === 'compare') {
                    statsDiv.innerHTML = renderSingle(data.user1, errors.user1, "⚠️ Only one user loaded. Comparison requires both users to be found.");
                } else if (data.user1) {
                    statsDiv.innerHTML = renderSingle(data.user1, errors.user1);
                } else {
                    statsDiv.textContent = `❌ Could not retrieve any statistics. ${errors.user1 || errors.user2 || ''}`;
                }

            } catch (err) {
                console.error(err);
                statsDiv.textContent = "❌ Network error. Please check your connection or try again.";
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get Stats'; // Fixed text
            }
        });

        // --- NEW HELPER FUNCTION: Determine Winners for Comparison ---
        function getWinners(data1, data2) {
            const winners = {};
            // Stats where higher is better
            const metrics = [
                'followers', 'following', 'project_count', 'favorited_projects_count', 
                'total_loves', 'total_favorites_received', 'total_views', 
                'avg_loves', 'avg_favorites', 'avg_views'
            ];
            
            // Days since last project: lower is better (more recent activity)
            // It's checked as a special case because it can be "N/A"
            if (typeof data1.days_since_last_project === 'number' && typeof data2.days_since_last_project === 'number') {
                if (data1.days_since_last_project < data2.days_since_last_project) {
                    winners['days_since_last_project'] = 'user1';
                } else if (data2.days_since_last_project < data1.days_since_last_project) {
                    winners['days_since_last_project'] = 'user2';
                }
            } else if (data1.days_since_last_project !== "N/A" && data2.days_since_last_project === "N/A") {
                winners['days_since_last_project'] = 'user1'; // User 1 has data, User 2 does not
            } else if (data2.days_since_last_project !== "N/A" && data1.days_since_last_project === "N/A") {
                winners['days_since_last_project'] = 'user2'; // User 2 has data, User 1 does not
            }

            metrics.forEach(metric => {
                const val1 = data1[metric] || 0;
                const val2 = data2[metric] || 0;
                
                if (val1 > val2) {
                    winners[metric] = 'user1';
                } else if (val2 > val1) {
                    winners[metric] = 'user2';
                }
            });
            return winners;
        }
        
        // --- Reusable Rendering Functions (Updated) ---

        function renderSingle(data, errorMsg, notice = '') {
            if (errorMsg) {
                return `<div class="error-message">❌ ${errorMsg}</div>`;
            }

            return `
                <div class="stats-container single-user">
                    ${notice ? `<div class="notice-message">${notice}</div>` : ''}
                    ${renderProfileHeader(data)}
                    <div class="user-info">
                        <p><strong>🆔 ID:</strong> ${data.id}</p>
                        <p><strong>📅 Joined:</strong> ${data.joined}</p>
                        <p><strong>🌍 Country:</strong> ${data.country}</p>
                        <p><strong>🕒 Last Activity:</strong> ${data.last_activity}</p>
                    </div>

                    ${renderActivity(data)}

                    <div class="stats-grid">
                        ${renderCoreStats(data)}
                        ${renderAverageStats(data)}
                    </div>
                    
                    ${renderProjectHighlights(data)}
                </div>
            `;
        }

        // Updated to accept and pass 'winners'
        function renderComparison(data1, data2, errors, winners) {
            const user1HTML = errors.user1 ? `<div class="user-col error-message">❌ ${errors.user1}</div>` : renderComparisonUser(data1, 'User 1', winners, 'user1');
            const user2HTML = errors.user2 ? `<div class="user-col error-message">❌ ${errors.user2}</div>` : renderComparisonUser(data2, 'User 2', winners, 'user2');
            
            return `
                <div class="comparison-container">
                    ${user1HTML}
                    ${user2HTML}
                </div>
            `;
        }
        
        // Updated to accept 'winners' and 'currentUserKey' and display last activity
        function renderComparisonUser(data, label, winners, currentUserKey) {
            return `
                <div class="user-col">
                    <h3 class="col-header">${label}</h3>
                    ${renderProfileHeader(data)}
                    <div class="user-info">
                        <p><strong>🆔 ID:</strong> ${data.id}</p>
                        <p><strong>📅 Joined:</strong> ${data.joined}</p>
                        <p><strong>🌍 Country:</strong> ${data.country}</p>
                        <p><strong>🕒 Last Activity:</strong> ${data.last_activity}</p> 
                    </div>
                    <div class="stats-grid comparison-grid">
                        ${renderComparisonCoreStats(data, winners, currentUserKey)}
                        ${renderComparisonAverageStats(data, winners, currentUserKey)}
                    </div>
                    ${renderTopProjectComparison(data)}
                </div>
            `;
        }
        
        function renderProfileHeader(data) {
            return `
                <div class="profile">
                    <img src="${data.profile_pic}" alt="Profile Picture">
                    <div>
                        <h2>${data.username} 
                            ${data.scratchteam ? '<span class="scratch-team-badge">⭐️ Scratch Team</span>' : ''}
                        </h2>
                        <a href="https://scratch.mit.edu/users/${data.username}" target="_blank" class="profile-btn">View Profile ↗️</a>
                    </div>
                </div>
            `;
        }

        function renderActivity(data) {
             return `
                <div class="activity-section">
                    <h4>💬 About Me</h4>
                    <p class="activity-content">${data.about_me || 'Nothing here yet!'}</p>
                    <h4>💻 What I'm Working On</h4>
                    <p class="activity-content">${data.wiwo || 'Nothing here yet!'}</p>
                </div>
            `;
        }
        
        // Updated for Single View to include Days Since Last Project
        function renderCoreStats(data) {
            // Check if days_since_last_project is a number, otherwise show 'N/A'
            const daysSinceLastProject = typeof data.days_since_last_project === 'number' 
                                         ? `${data.days_since_last_project.toLocaleString()} days ago` 
                                         : data.days_since_last_project;

            return `
                <p><strong>👥 Followers:</strong> ${data.followers.toLocaleString()}</p>
                <p><strong>➕ Following:</strong> ${data.following.toLocaleString()}</p>
                <p><strong>📁 Total Projects:</strong> ${data.project_count.toLocaleString()}</p>
                <p><strong>📅 Last Project:</strong> ${daysSinceLastProject}</p>
                <p><strong>⭐ Projects Faved:</strong> ${data.favorited_projects_count.toLocaleString()}</p>
                <p><strong>✨ TOTAL FAVES REC:</strong> ${data.total_favorites_received.toLocaleString()}</p>
                <p><strong>❤️ TOTAL LOVES REC:</strong> ${data.total_loves.toLocaleString()}</p>
                <p><strong>👁️ Total Views:</strong> ${data.total_views.toLocaleString()}</p>
            `;
        }

        // NEW function for Comparison View with highlighting
        function renderComparisonCoreStats(data, winners, currentUserKey) {
            // Helper function to apply winner class
            const getWinnerClass = (metric) => winners[metric] === currentUserKey ? 'winner-stat' : '';
            
            // Days Since Last Project with winner check
            const daysSinceLastProject = typeof data.days_since_last_project === 'number' 
                                         ? `${data.days_since_last_project.toLocaleString()} days ago` 
                                         : data.days_since_last_project;
            const daysClass = getWinnerClass('days_since_last_project');


            return `
                <p class="${getWinnerClass('followers')}"><strong>👥 Followers:</strong> ${data.followers.toLocaleString()}</p>
                <p class="${getWinnerClass('following')}"><strong>➕ Following:</strong> ${data.following.toLocaleString()}</p>
                <p class="${getWinnerClass('project_count')}"><strong>📁 Total Projects:</strong> ${data.project_count.toLocaleString()}</p>
                <p class="${daysClass}"><strong>📅 Last Project:</strong> ${daysSinceLastProject}</p>
                <p class="${getWinnerClass('favorited_projects_count')}"><strong>⭐ Projects Faved:</strong> ${data.favorited_projects_count.toLocaleString()}</p>
                <p class="${getWinnerClass('total_favorites_received')}"><strong>✨ TOTAL FAVES REC:</strong> ${data.total_favorites_received.toLocaleString()}</p>
                <p class="${getWinnerClass('total_loves')}"><strong>❤️ TOTAL LOVES REC:</strong> ${data.total_loves.toLocaleString()}</p>
                <p class="${getWinnerClass('total_views')}"><strong>👁️ Total Views:</strong> ${data.total_views.toLocaleString()}</p>
            `;
        }

        // Used for single user view
        function renderAverageStats(data) {
            return `
                <p><strong>❤️ Avg. Loves/Project:</strong> ${data.avg_loves.toFixed(2)}</p>
                <p><strong>✨ Avg. Faves/Project:</strong> ${data.avg_favorites.toFixed(2)}</p>
                <p><strong>👁️ Avg. Views/Project:</strong> ${data.avg_views.toFixed(2)}</p>
            `;
        }
        
        // NEW function for Comparison View with highlighting
        function renderComparisonAverageStats(data, winners, currentUserKey) {
            const getWinnerClass = (metric) => winners[metric] === currentUserKey ? 'winner-stat' : '';
            return `
                <p class="${getWinnerClass('avg_loves')}"><strong>❤️ Avg. Loves/Project:</strong> ${data.avg_loves.toFixed(2)}</p>
                <p class="${getWinnerClass('avg_favorites')}"><strong>✨ Avg. Faves/Project:</strong> ${data.avg_favorites.toFixed(2)}</p>
                <p class="${getWinnerClass('avg_views')}"><strong>👁️ Avg. Views/Project:</strong> ${data.avg_views.toFixed(2)}</p>
            `;
        }

        function renderProjectHighlights(data) {
            const hasProjects = data.most_loved || data.most_viewed || data.most_recent;
            if (!hasProjects) return "<p>No projects found.</p>";

            return `
                <div class="project-highlights-container">
                    ${renderProjectBox(data.most_recent, "🕒 Most Recent Project", "🕒 Last Updated", "id", "loves", "views", "favorites")}
                    ${renderProjectBox(data.most_loved, "🏆 Most Loved Project", "❤️ Loves", "loves", "views", "favorites")}
                    ${renderProjectBox(data.most_viewed, "👁️ Most Viewed Project", "👁️ Views", "views", "loves", "favorites")}
                </div>
            `;
        }
        
        function renderTopProjectComparison(data) {
            const m_loved = data.most_loved;
            const m_viewed = data.most_viewed;
            const m_recent = data.most_recent;

            if (!m_loved && !m_viewed && !m_recent) return '';

            return `
                <div class="comparison-project-summary">
                    <h4>Top Projects</h4>
                    ${m_recent ? `<p><strong>🕒 Recent:</strong> <a href="https://scratch.mit.edu/projects/${m_recent.id}">${m_recent.title}</a></p>` : ''}
                    ${m_loved ? `<p><strong>🏆 Loved:</strong> <a href="https://scratch.mit.edu/projects/${m_loved.id}">${m_loved.title}</a> (${m_loved.loves.toLocaleString()})</p>` : ''}
                    ${m_viewed ? `<p><strong>👁️ Viewed:</strong> <a href="https://scratch.mit.edu/projects/${m_viewed.id}">${m_viewed.title}</a> (${m_viewed.views.toLocaleString()})</p>` : ''}
                </div>
            `;
        }

        function renderProjectBox(project, title, metricLabel, metricKey, ...otherKeys) {
            if (!project) return '';
            
            let statsHtml = '';
            
            if (metricKey === 'id') {
                 statsHtml = `<span>${metricLabel} (ID ${project.id})</span>`;
            } else {
                 statsHtml = `<span>${metricLabel} ${project[metricKey].toLocaleString()}</span>`;
            }

            otherKeys.forEach(key => {
                const label = key === 'loves' ? '❤️' : key === 'views' ? '👁️' : key === 'favorites' ? '⭐' : '';
                const value = project[key] || 0;
                if (label) statsHtml += `<span>${label} ${value.toLocaleString()}</span>`;
            });

            return `
                <div class="project-box">
                    <h3>${title}</h3>
                    <img src="https://cdn2.scratch.mit.edu/get_image/project/${project.id}_144x108.png" 
                         alt="${project.title} thumbnail" class="project-thumbnail">
                    <p class="project-title">${project.title}</p>
                    <div class="project-stats">
                        ${statsHtml}
                    </div>
                    <a href="https://scratch.mit.edu/projects/${project.id}" target="_blank" class="project-btn">View Project ↗️</a>
                </div>
            `;
        }
    </script>
</body>
</html>
