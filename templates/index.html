<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch Stats Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    
    <nav>
        <div class="nav-title">Scratch Stats Dashboard</div>
        <div class="nav-links">
            <a href="/" id="single-link" class="nav-link">Single Search</a>
            <a href="/compare" id="compare-link" class="nav-link">Compare Stats</a>
        </div>
    </nav>
    
    <div class="main-content">
        <h1 id="main-header">Scratch Stats Dashboard</h1>
        <p id="main-subheader">Enter a Scratch username below ğŸ‘‡</p>

        <form id="statsForm" data-mode="{{ view_mode }}">
            <div class="input-group">
                <input type="text" id="username1" name="username1" placeholder="Username 1 (e.g. jw_s)" required>
                <input type="text" id="username2" name="username2" placeholder="Username 2 (optional)">
            </div>
            <button type="submit" id="submitBtn">Get Stats</button>
        </form>

        <div id="stats"></div>
    </div>

    <script>
        const form = document.getElementById("statsForm");
        const statsDiv = document.getElementById("stats");
        const submitBtn = document.getElementById("submitBtn");
        const viewMode = form.dataset.mode;
        const header = document.getElementById("main-header");
        const subheader = document.getElementById("main-subheader");
        
        // --- Setup View Mode and Navigation ---
        if (viewMode === 'compare') {
            header.textContent = 'Compare Two Scratch Users';
            subheader.textContent = 'Enter the usernames you want to compare.';
            document.getElementById('username2').style.display = 'block';
            document.getElementById('compare-link').classList.add('active');
        } else {
            document.getElementById('username2').style.display = 'none';
            document.getElementById('single-link').classList.add('active');
        }
        
        // --- Form Submission Handler (Handles both views) ---
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const username1 = document.getElementById("username1").value.trim();
            const username2 = document.getElementById("username2").value.trim();
            
            // UX Improvement: Loading State and Button Disabling
            statsDiv.innerHTML = '<div class="loading-spinner"></div> Fetching data...';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Fetching...';

            if (!username1) {
                statsDiv.textContent = "âŒ Please enter a username.";
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get Stats';
                return;
            }

            // Prepare the body for the API request
            const params = new URLSearchParams();
            params.append('username1', username1);
            if (viewMode === 'compare' && username2) {
                params.append('username2', username2);
            } else if (viewMode === 'single') {
                 // For single search, we want to ensure only username1 is sent, even if the field for 2 is hidden.
                 // The backend handles the absence of username2.
            }

            try {
                const res = await fetch("/api/stats", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: params.toString()
                });
                
                const response = await res.json();
                
                // UX Improvement: Handle non-200 errors from backend
                if (!res.ok) {
                    statsDiv.textContent = `âŒ Error: ${response.error || 'Could not connect to server/API.'}`;
                    return;
                }
                
                const data = response.data;
                const errors = response.errors || {};

                // Render logic based on mode and successful fetches
                if (viewMode === 'compare' && (data.user1 && data.user2)) {
                    statsDiv.innerHTML = renderComparison(data.user1, data.user2, errors);
                } else if (data.user1 && viewMode === 'compare') {
                    // Fallback to single view if user 2 was empty or failed
                    statsDiv.innerHTML = renderSingle(data.user1, errors.user1, "Only one user found or the second user failed to load.");
                } else if (data.user1) {
                    statsDiv.innerHTML = renderSingle(data.user1, errors.user1);
                } else {
                    statsDiv.textContent = `âŒ Could not retrieve any statistics. ${errors.user1 || errors.user2 || ''}`;
                }

            } catch (err) {
                console.error(err);
                statsDiv.textContent = "âŒ Network error. Please check your connection or try again.";
            } finally {
                // UX Improvement: Resetting button state
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get Stats';
            }
        });
        
        // --- Reusable Rendering Functions (Modified for new metrics and views) ---
        
        function renderSingle(data, errorMsg, notice = '') {
            if (errorMsg) {
                return `<div class="error-message">âŒ ${errorMsg}</div>`;
            }

            return `
                <div class="stats-container single-user">
                    ${notice ? `<div class="notice-message">âš ï¸ ${notice}</div>` : ''}
                    ${renderProfileHeader(data)}
                    <div class="user-info">
                        <p><strong>ğŸ†” ID:</strong> ${data.id}</p>
                        <p><strong>ğŸ“… Joined:</strong> ${data.joined}</p>
                        <p><strong>ğŸŒ Country:</strong> ${data.country}</p>
                    </div>

                    ${renderActivity(data)}

                    <div class="stats-grid">
                        ${renderCoreStats(data)}
                        ${renderAverageStats(data)}
                    </div>
                    
                    ${renderProjectHighlights(data)}
                </div>
            `;
        }

        function renderComparison(data1, data2, errors) {
            const user1HTML = errors.user1 ? `<div class="user-col error-message">âŒ ${errors.user1}</div>` : renderComparisonUser(data1, 'User 1');
            const user2HTML = errors.user2 ? `<div class="user-col error-message">âŒ ${errors.user2}</div>` : renderComparisonUser(data2, 'User 2');
            
            return `
                <div class="comparison-container">
                    ${user1HTML}
                    ${user2HTML}
                </div>
            `;
        }
        
        function renderComparisonUser(data, label) {
            return `
                <div class="user-col">
                    <h3 class="col-header">${label}</h3>
                    ${renderProfileHeader(data)}
                    <div class="user-info">
                        <p><strong>ğŸ†” ID:</strong> ${data.id}</p>
                        <p><strong>ğŸ“… Joined:</strong> ${data.joined}</p>
                        <p><strong>ğŸŒ Country:</strong> ${data.country}</p>
                    </div>
                    <div class="stats-grid comparison-grid">
                        ${renderCoreStats(data)}
                        ${renderAverageStats(data)}
                    </div>
                    ${renderTopProjectComparison(data)}
                </div>
            `;
        }
        
        function renderProfileHeader(data) {
            return `
                <div class="profile">
                    <img src="${data.profile_pic}" alt="Profile Picture">
                    <div>
                        <h2>${data.username} 
                            ${data.scratchteam ? '<span class="scratch-team-badge">â­ï¸ Scratch Team</span>' : ''}
                        </h2>
                        <a href="https://scratch.mit.edu/users/${data.username}" target="_blank" class="profile-btn">View Profile â†—ï¸</a>
                    </div>
                </div>
            `;
        }

        function renderActivity(data) {
             return `
                <div class="activity-section">
                    <h4>ğŸ’¬ About Me</h4>
                    <p class="activity-content">${data.about_me || 'Nothing here yet!'}</p>
                    <h4>ğŸ’» What I'm Working On</h4>
                    <p class="activity-content">${data.wiwo || 'Nothing here yet!'}</p>
                </div>
            `;
        }
        
        // Updated to include total comments
        function renderCoreStats(data) {
            return `
                <p><strong>ğŸ‘¥ Followers:</strong> ${data.followers.toLocaleString()}</p>
                <p><strong>â• Following:</strong> ${data.following.toLocaleString()}</p>
                <p><strong>ğŸ“ Total Projects:</strong> ${data.project_count.toLocaleString()}</p>
                <p><strong>â­ Projects Faved:</strong> ${data.favorited_projects_count.toLocaleString()}</p>
                <p><strong>âœ¨ TOTAL FAVES REC:</strong> ${data.total_favorites_received.toLocaleString()}</p>
                <p><strong>â¤ï¸ TOTAL LOVES REC:</strong> ${data.total_loves.toLocaleString()}</p>
                <p><strong>ğŸ‘ï¸ Total Views:</strong> ${data.total_views.toLocaleString()}</p>
                <p><strong>ğŸ’¬ Total Comments:</strong> ${data.total_comments.toLocaleString()}</p>
            `;
        }

        // Updated to include average comments and engagement score
        function renderAverageStats(data) {
            return `
                <p><strong>â¤ï¸ Avg. Loves/Project:</strong> ${data.avg_loves.toFixed(2)}</p>
                <p><strong>âœ¨ Avg. Faves/Project:</strong> ${data.avg_favorites.toFixed(2)}</p>
                <p><strong>ğŸ‘ï¸ Avg. Views/Project:</strong> ${data.avg_views.toFixed(2)}</p>
                <p><strong>ğŸ’¬ Avg. Comments/Project:</strong> ${data.avg_comments.toFixed(2)}</p>
                <p class="ratio-stat"><strong>ğŸ“ˆ Engagement Score (C/V):</strong> ${data.comments_per_view.toFixed(4)}</p>
            `;
        }

        // Single View Project Highlights (All three top projects shown)
        function renderProjectHighlights(data) {
            const hasProjects = data.most_loved || data.most_viewed || data.most_commented;
            if (!hasProjects) return "<p>No projects found.</p>";

            return `
                <div class="project-highlights-container">
                    ${renderProjectBox(data.most_loved, "ğŸ† Most Loved Project", "â¤ï¸ Loves", "loves", "views", "favorites", "comments")}
                    ${renderProjectBox(data.most_viewed, "ğŸ‘ï¸ Most Viewed Project", "ğŸ‘ï¸ Views", "views", "loves", "favorites", "comments")}
                    ${renderProjectBox(data.most_commented, "ğŸ’¬ Most Commented Project", "ğŸ’¬ Comments", "comments", "loves", "views", "favorites")}
                </div>
            `;
        }
        
        // Comparison View Project Summary (Simpler display to save space)
        function renderTopProjectComparison(data) {
            const m_loved = data.most_loved;
            const m_viewed = data.most_viewed;
            const m_commented = data.most_commented;

            if (!m_loved && !m_viewed && !m_commented) return '';

            return `
                <div class="comparison-project-summary">
                    <h4>Top Projects</h4>
                    ${m_loved ? `<p><strong>ğŸ† Loved:</strong> <a href="https://scratch.mit.edu/projects/${m_loved.id}">${m_loved.title}</a> (${m_loved.loves.toLocaleString()})</p>` : ''}
                    ${m_viewed ? `<p><strong>ğŸ‘ï¸ Viewed:</strong> <a href="https://scratch.mit.edu/projects/${m_viewed.id}">${m_viewed.title}</a> (${m_viewed.views.toLocaleString()})</p>` : ''}
                    ${m_commented ? `<p><strong>ğŸ’¬ Commented:</strong> <a href="https://scratch.mit.edu/projects/${m_commented.id}">${m_commented.title}</a> (${m_commented.comments.toLocaleString()})</p>` : ''}
                </div>
            `;
        }

        function renderProjectBox(project, title, metricLabel, metricKey, ...otherKeys) {
            if (!project) return '';
            
            let statsHtml = `<span>${metricLabel} ${project[metricKey].toLocaleString()}</span>`;
            
            otherKeys.forEach(key => {
                const label = key === 'loves' ? 'â¤ï¸' : key === 'views' ? 'ğŸ‘ï¸' : key === 'favorites' ? 'â­' : key === 'comments' ? 'ğŸ’¬' : '';
                const value = project[key] || 0;
                if (label) statsHtml += `<span>${label} ${value.toLocaleString()}</span>`;
            });

            return `
                <div class="project-box">
                    <h3>${title}</h3>
                    <img src="https://cdn2.scratch.mit.edu/get_image/project/${project.id}_144x108.png" 
                         alt="${project.title} thumbnail" class="project-thumbnail">
                    <p class="project-title">${project.title}</p>
                    <div class="project-stats">
                        ${statsHtml}
                    </div>
                    <a href="https://scratch.mit.edu/projects/${project.id}" target="_blank" class="project-btn">View Project â†—ï¸</a>
                </div>
            `;
        }

    </script>
</body>
</html>
