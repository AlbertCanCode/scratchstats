<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="google-site-verification" content="hxiX__ldpj9hmreGCLfXADf1fZYuTdIq3i8BY7imPU0" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch Stats</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='title.png') }}">


</head>
<body>
    
    <nav>
        <div class="nav-container">
            <div class="nav-links">
                <a href="/" id="single-link" class="nav-link">Single Search</a>
                <a href="/compare" id="compare-link" class="nav-link">Compare Stats</a>
            </div>
        </div>
    </nav>
    
    <div class="main-content">
        <h1 id="main-header">Scratch Stats</h1>
        <p id="main-subheader">Enter a Scratch username below ğŸ‘‡</p>

        <form id="statsForm" data-mode="{{ view_mode }}">
            <div class="input-group">
                <input type="text" id="username1" name="username1" placeholder="e.g ChessProKing-TM" required>
                <input type="text" id="username2" name="username2" placeholder="e.g griffpatch">
            </div>
            <button type="submit" id="submitBtn">Get Stats</button>
        </form>

        <div id="stats"></div>
    </div>

    <footer>
        Made by Scratch user <a href="https://scratch.mit.edu/users/ChessProKing-TM" target="_blank">ChessProKing-TM</a>
    </footer>

    <script>
        const form = document.getElementById("statsForm");
        const statsDiv = document.getElementById("stats");
        const submitBtn = document.getElementById("submitBtn");
        const username1Input = document.getElementById("username1");
        const viewMode = form.dataset.mode;
        const header = document.getElementById("main-header");
        const subheader = document.getElementById("main-subheader");
        
        // --- Setup View Mode and Navigation ---
        const username2Input = document.getElementById('username2');

        if (viewMode === 'compare') {
            header.textContent = 'Compare Two Scratch Users';
            subheader.textContent = 'Enter the usernames you want to compare.';
            username2Input.style.display = 'block';
            username2Input.required = true;
            document.getElementById('compare-link').classList.add('active');
        } else {
            // SINGLE VIEW
            header.textContent = 'Scratch Stats';
            subheader.textContent = 'Enter a Scratch username below ğŸ‘‡';
            username2Input.style.display = 'none';
            username2Input.required = false;
            document.getElementById('single-link').classList.add('active');
        }
        
        // --- Form Submission Handler (Handles both views) ---
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const username1 = username1Input.value.trim();
            const username2 = username2Input.value.trim();
            
            // UX Improvement: Loading State and Button Disabling
            statsDiv.innerHTML = '<div class="loading-spinner"></div> Fetching data...';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Fetching...';

            if (!username1) {
                statsDiv.textContent = "âŒ Please enter a username.";
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get Stats'; // Fixed text
                return;
            }

            if (viewMode === 'compare' && !username2) {
                statsDiv.textContent = "âŒ Please enter both usernames for comparison.";
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get Stats'; // Fixed text
                return;
            }

            const params = new URLSearchParams();
            params.append('username1', username1);
            if (username2) {
                params.append('username2', username2);
            }

            try {
                const res = await fetch("/api/stats", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: params.toString()
                });
                
                const response = await res.json();
                
                if (!res.ok) {
                    statsDiv.textContent = `âŒ Error: ${response.error || 'Could not connect to server/API.'}`;
                    return;
                }
                
                const data = response.data;
                const errors = response.errors || {};

                if (viewMode === 'compare' && (data.user1 && data.user2)) {
                    // Pass ALL data to renderComparison to enable full comparison logic
                    statsDiv.innerHTML = renderComparison(data.user1, data.user2, errors);
                } else if (data.user1 && viewMode === 'compare') {
                    statsDiv.innerHTML = renderSingle(data.user1, errors.user1, "âš ï¸ Only one user loaded. Comparison requires both users to be found.");
                } else if (data.user1) {
                    statsDiv.innerHTML = renderSingle(data.user1, errors.user1);
                } else {
                    statsDiv.textContent = `âŒ Could not retrieve any statistics. ${errors.user1 || errors.user2 || ''}`;
                }

            } catch (err) {
                console.error(err);
                statsDiv.textContent = "âŒ Network error. Please check your connection or try again.";
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get Stats'; // Fixed text
            }
        });
        
        // --- Highlighting Helpers (NEW) ---

        // Helper to determine the class based on comparison
        function getComparisonClass(val1, val2, reverse_win = false) {
            val1 = typeof val1 === 'string' ? 0 : val1 || 0;
            val2 = typeof val2 === 'string' ? 0 : val2 || 0;

            if (val1 === val2 && val1 !== 0) {
                 return 'highlight-tie';
            } else if (val1 > val2) {
                return reverse_win ? 'highlight-loser' : 'highlight-winner';
            } else if (val2 > val1) {
                return reverse_win ? 'highlight-winner' : 'highlight-loser';
            }
            return '';
        }

        // Helper function to compare two values and return the HTML with highlighting class
        function compareAndRenderStat(key, label, data1, data2, reverse_win = false) {
            const val1 = data1[key];
            const val2 = data2[key];
            
            let class1 = getComparisonClass(val1, val2, reverse_win);
            let class2 = getComparisonClass(val2, val1, reverse_win);
            
            // Formatting based on key
            const formatValue = (value) => {
                if (key.includes('avg')) {
                    return typeof value === 'number' ? value.toFixed(2) : value;
                }
                if (key === 'days_since_last_project') {
                     return `${value} days`;
                }
                return typeof value === 'number' ? value.toLocaleString() : value;
            };

            const html1 = `<p class="${class1}"><strong>${label}:</strong> ${formatValue(val1)}</p>`;
            const html2 = `<p class="${class2}"><strong>${label}:</strong> ${formatValue(val2)}</p>`;
            
            return { html1, html2 };
        }


        // --- Reusable Rendering Functions (UPDATED) ---

        function renderSingle(data, errorMsg, notice = '') {
            if (errorMsg) {
                return `<div class="error-message">âŒ ${errorMsg}</div>`;
            }

            return `
                <div class="stats-container single-user">
                    ${notice ? `<div class="notice-message">${notice}</div>` : ''}
                    ${renderProfileHeader(data)}
                    <div class="user-info">
                        <p><strong>ğŸ†” ID:</strong> ${data.id}</p>
                        <p><strong>ğŸ“… Joined:</strong> ${data.joined}</p>
                        <p><strong>ğŸŒ Country:</strong> ${data.country}</p>
                        <p><strong>ğŸ•’ Recent Activity:</strong> ${data.most_recent_activity}</p>
                        <p><strong>â³ Days Since Project:</strong> ${data.days_since_last_project} days</p>
                    </div>

                    ${renderActivity(data)}

                    <div class="stats-grid">
                        ${renderCoreStats(data)}
                        ${renderAverageStats(data)}
                    </div>
                    
                    ${renderProjectHighlights(data)}
                </div>
            `;
        }
        
        function renderComparison(data1, data2, errors) {
            
            // --- Determine Comparison Stats for Highlighting ---
            
            // Stats where higher is better (reverse_win=false)
            const followerStats = compareAndRenderStat('followers', 'ğŸ‘¥ Followers', data1, data2, false);
            const followingStats = compareAndRenderStat('following', 'â• Following', data1, data2, false);
            const totalProjectsStats = compareAndRenderStat('project_count', 'ğŸ“ Total Projects', data1, data2, false);
            const favedProjectsStats = compareAndRenderStat('favorited_projects_count', 'â­ Projects Faved', data1, data2, false);
            const totalFavesStats = compareAndRenderStat('total_favorites_received', 'âœ¨ TOTAL FAVES REC', data1, data2, false);
            const totalLovesStats = compareAndRenderStat('total_loves', 'â¤ï¸ TOTAL LOVES REC', data1, data2, false);
            const totalViewsStats = compareAndRenderStat('total_views', 'ğŸ‘ï¸ Total Views', data1, data2, false);
            const avgLovesStats = compareAndRenderStat('avg_loves', 'â¤ï¸ Avg. Loves/Project', data1, data2, false);
            const avgFavesStats = compareAndRenderStat('avg_favorites', 'âœ¨ Avg. Faves/Project', data1, data2, false);
            const avgViewsStats = compareAndRenderStat('avg_views', 'ğŸ‘ï¸ Avg. Views/Project', data1, data2, false);
            
            // Stats where lower is better (reverse_win=true)
            const daysSinceStats = compareAndRenderStat('days_since_last_project', 'â³ Days Since Project', data1, data2, true);

            // --- Project Highlighting Classes (NEW) ---
            const loved_class1 = getComparisonClass(data1.most_loved?.loves, data2.most_loved?.loves, false);
            const loved_class2 = getComparisonClass(data2.most_loved?.loves, data1.most_loved?.loves, false);
            const viewed_class1 = getComparisonClass(data1.most_viewed?.views, data2.most_viewed?.views, false);
            const viewed_class2 = getComparisonClass(data2.most_viewed?.views, data1.most_viewed?.views, false);


            // Generate Comparison User HTML with highlighting
            const renderComparisonUserWithHighlighting = (data, label, errors, isUser1) => {
                // If the user's data failed to load, display the error instead of trying to render stats.
                if (errors.user1 && isUser1 || errors.user2 && !isUser1) {
                    return `<div class="user-col error-message">âŒ ${isUser1 ? errors.user1 : errors.user2}</div>`;
                }
                
                // Get the appropriate stat HTML based on user
                const getStatHtml = (stats) => isUser1 ? stats.html1 : stats.html2;
                
                // Get the appropriate project highlighting class
                const lovedClass = isUser1 ? loved_class1 : loved_class2;
                const viewedClass = isUser1 ? viewed_class1 : viewed_class2;

                return `
                    <div class="user-col">
                        <h3 class="col-header">${label}</h3>
                        ${renderProfileHeader(data)}
                        <div class="user-info">
                            <p><strong>ğŸ†” ID:</strong> ${data.id}</p>
                            <p><strong>ğŸ“… Joined:</strong> ${data.joined}</p>
                            <p><strong>ğŸŒ Country:</strong> ${data.country}</p>
                            <p><strong>ğŸ•’ Recent Activity:</strong> ${data.most_recent_activity}</p>
                            ${getStatHtml(daysSinceStats)}
                        </div>
                        <div class="stats-grid comparison-grid">
                            ${getStatHtml(followerStats)}
                            ${getStatHtml(followingStats)}
                            ${getStatHtml(totalProjectsStats)}
                            ${getStatHtml(favedProjectsStats)}
                            ${getStatHtml(totalFavesStats)}
                            ${getStatHtml(totalLovesStats)}
                            ${getStatHtml(totalViewsStats)}
                            ${getStatHtml(avgLovesStats)}
                            ${getStatHtml(avgFavesStats)}
                            ${getStatHtml(avgViewsStats)}
                        </div>
                        ${renderTopProjectComparison(data, lovedClass, viewedClass)}
                    </div>
                `;
            };

            const user1HTML = renderComparisonUserWithHighlighting(data1, data1.username, errors, true);
            const user2HTML = renderComparisonUserWithHighlighting(data2, data2.username, errors, false);

            return `
                <div class="comparison-container">
                    ${user1HTML}
                    ${user2HTML}
                </div>
                <div class="highlight-key">
                    <span class="highlight-winner">Winner</span>
                    <span class="highlight-loser">Loser</span>
                    <span class="highlight-tie">Tie</span>
                </div>
            `;
        }

        function renderProfileHeader(data) {
            return `
                <div class="profile">
                    <img src="${data.profile_pic}" alt="Profile Picture">
                    <div>
                        <h2>${data.username} 
                            ${data.scratchteam ? '<span class="scratch-team-badge">â­ï¸ Scratch Team</span>' : ''}
                        </h2>
                        <a href="https://scratch.mit.edu/users/${data.username}" target="_blank" class="profile-btn">View Profile â†—ï¸</a>
                    </div>
                </div>
            `;
        }

        function renderActivity(data) {
             return `
                <div class="activity-section">
                    <h4>ğŸ’¬ About Me</h4>
                    <p class="activity-content">${data.about_me || 'Nothing here yet!'}</p>
                    <h4>ğŸ’» What I'm Working On</h4>
                    <p class="activity-content">${data.wiwo || 'Nothing here yet!'}</p>
                </div>
            `;
        }
        
        function renderCoreStats(data) {
            return `
                <p><strong>ğŸ‘¥ Followers:</strong> ${data.followers.toLocaleString()}</p>
                <p><strong>â• Following:</strong> ${data.following.toLocaleString()}</p>
                <p><strong>ğŸ“ Total Projects:</strong> ${data.project_count.toLocaleString()}</p>
                <p><strong>â­ Projects Faved:</strong> ${data.favorited_projects_count.toLocaleString()}</p>
                <p><strong>âœ¨ TOTAL FAVES REC:</strong> ${data.total_favorites_received.toLocaleString()}</p>
                <p><strong>â¤ï¸ TOTAL LOVES REC:</strong> ${data.total_loves.toLocaleString()}</p>
                <p><strong>ğŸ‘ï¸ Total Views:</strong> ${data.total_views.toLocaleString()}</p>
            `;
        }

        function renderAverageStats(data) {
            return `
                <p><strong>â¤ï¸ Avg. Loves/Project:</strong> ${data.avg_loves.toFixed(2)}</p>
                <p><strong>âœ¨ Avg. Faves/Project:</strong> ${data.avg_favorites.toFixed(2)}</p>
                <p><strong>ğŸ‘ï¸ Avg. Views/Project:</strong> ${data.avg_views.toFixed(2)}</p>
            `;
        }

        function renderProjectHighlights(data) {
            const hasProjects = data.most_loved || data.most_viewed || data.most_recent;
            if (!hasProjects) return "<p>No projects found.</p>";

            return `
                <div class="project-highlights-container">
                    ${renderProjectBox(data.most_recent, "ğŸ•’ Most Recent Project", "ğŸ•’ Last Updated", "id", "loves", "views", "favorites")}
                    ${renderProjectBox(data.most_loved, "ğŸ† Most Loved Project", "â¤ï¸ Loves", "loves", "views", "favorites")}
                    ${renderProjectBox(data.most_viewed, "ğŸ‘ï¸ Most Viewed Project", "ğŸ‘ï¸ Views", "views", "loves", "favorites")}
                </div>
            `;
        }
        
        function renderTopProjectComparison(data, lovedClass, viewedClass) {
            const m_loved = data.most_loved;
            const m_viewed = data.most_viewed;
            const m_recent = data.most_recent;

            if (!m_loved && !m_viewed && !m_recent) return '';

            return `
                <div class="comparison-project-summary">
                    <h4>Top Projects</h4>
                    ${m_recent ? `<p><strong>ğŸ•’ Recent:</strong> <a href="https://scratch.mit.edu/projects/${m_recent.id}">${m_recent.title}</a></p>` : ''}
                    ${m_loved ? `<p><strong>ğŸ† Loved:</strong> <a href="https://scratch.mit.edu/projects/${m_loved.id}" class="${lovedClass}">${m_loved.title}</a> (${m_loved.loves.toLocaleString()})</p>` : ''}
                    ${m_viewed ? `<p><strong>ğŸ‘ï¸ Viewed:</strong> <a href="https://scratch.mit.edu/projects/${m_viewed.id}" class="${viewedClass}">${m_viewed.title}</a> (${m_viewed.views.toLocaleString()})</p>` : ''}
                </div>
            `;
        }

        function renderProjectBox(project, title, metricLabel, metricKey, ...otherKeys) {
            if (!project) return '';
            
            let statsHtml = '';
            
            if (metricKey === 'id') {
                 statsHtml = `<span>${metricLabel} (ID ${project.id})</span>`;
            } else {
                 statsHtml = `<span>${metricLabel} ${project[metricKey].toLocaleString()}</span>`;
            }

            otherKeys.forEach(key => {
                const label = key === 'loves' ? 'â¤ï¸' : key === 'views' ? 'ğŸ‘ï¸' : key === 'favorites' ? 'â­' : '';
                const value = project[key] || 0;
                if (label) statsHtml += `<span>${label} ${value.toLocaleString()}</span>`;
            });

            return `
                <div class="project-box">
                    <h3>${title}</h3>
                    <img src="https://cdn2.scratch.mit.edu/get_image/project/${project.id}_144x108.png" 
                         alt="${project.title} thumbnail" class="project-thumbnail">
                    <p class="project-title">${project.title}</p>
                    <div class="project-stats">
                        ${statsHtml}
                    </div>
                    <a href="https://scratch.mit.edu/projects/${project.id}" target="_blank" class="project-btn">View Project â†—ï¸</a>
                </div>
            `;
        }
    </script>
</body>
</html>
